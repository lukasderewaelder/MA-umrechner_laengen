<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Umrechner Längeneinheiten</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Custom Animations & Utilities */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translate(-50%, 20px); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
        @keyframes zoomIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        .animate-slide-up { animation: slideUp 0.5s ease-out forwards; }
        .animate-zoom-in { animation: zoomIn 0.2s ease-out; }

        /* Hide scrollbar for clean UI but keep functionality */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Remove spinner from number inputs */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }

        /* Prevent scrolling while dragging on touch devices */
        .touch-none {
            touch-action: none;
        }
    </style>
</head>
<body class="bg-stone-50 font-sans text-slate-800 min-h-screen select-none overflow-hidden fixed inset-0">

    <!-- Scrollable Main Container -->
    <div id="app" class="h-full w-full overflow-y-auto flex flex-col items-center p-2 md:p-6 pb-40">
        <!-- Content will be injected here by JavaScript -->
    </div>

    <!-- 
        STATIC RESULT CARD 
        Responsiver gemacht: schmaler auf Mobile (w-[90%]), kleinere Schriftarten.
    -->
    <div id="result-card" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-40 animate-slide-up w-[95%] max-w-md md:w-auto">
        <div class="bg-stone-800/95 backdrop-blur-md text-white p-4 md:p-6 rounded-2xl shadow-2xl border border-stone-600 flex items-center justify-between gap-4 md:gap-6">
            <div class="flex-1 min-w-0"> <!-- min-w-0 ensures truncation works if needed -->
                <div class="text-stone-400 text-[10px] md:text-xs font-bold uppercase tracking-wider mb-1">Ergebnis</div>
                <div id="res-value" class="text-4xl md:text-5xl font-mono font-bold text-green-400 tabular-nums tracking-tight truncate">0</div>
            </div>
            <div class="h-10 md:h-12 w-px bg-stone-600 shrink-0"></div>
            <div id="res-unit" class="text-2xl md:text-3xl font-bold text-white shrink-0">m</div>
        </div>
    </div>

    <script>
        // --- KONFIGURATION ---
        const COLUMNS = [
            { id: 'km', label: 'km', sub: 'Kilometer', factor: 1000000, color: 'bg-red-100', border: 'border-red-200' },
            { id: 'hm', label: 'hm', sub: 'Hektometer', factor: 100000, color: 'bg-orange-100', border: 'border-orange-200' },
            { id: 'dam', label: 'dam', sub: 'Dekameter', factor: 10000, color: 'bg-orange-50', border: 'border-orange-100' },
            { id: 'm', label: 'm', sub: 'Meter', factor: 1000, color: 'bg-yellow-100', border: 'border-yellow-200' },
            { id: 'dm', label: 'dm', sub: 'Dezimeter', factor: 100, color: 'bg-green-100', border: 'border-green-200' },
            { id: 'cm', label: 'cm', sub: 'Zentimeter', factor: 10, color: 'bg-teal-100', border: 'border-teal-200' },
            { id: 'mm', label: 'mm', sub: 'Millimeter', factor: 1, color: 'bg-blue-100', border: 'border-blue-200' },
        ];

        // --- STATE MANAGEMENT ---
        const state = {
            digits: {}, 
            sliderUnit: 'm',
            showInstructions: false,
            isDragging: false,
            lastFocusedInput: null
        };

        // --- LOGIC FUNCTIONS ---
        function updateDigit(colId, value) {
            state.lastFocusedInput = { id: `input-${colId}`, cursor: null };
            if (value === '' || value === null) {
                delete state.digits[colId];
            } else {
                const cleanVal = value.toString().slice(-1); 
                if (/[0-9]/.test(cleanVal)) {
                    state.digits[colId] = cleanVal;
                }
            }
            render();
        }

        function incrementDigit(colId) {
            const currentVal = state.digits[colId] ? parseInt(state.digits[colId]) : null;
            let nextVal = currentVal === null ? 1 : (currentVal === 9 ? 0 : currentVal + 1);
            state.digits[colId] = nextVal.toString();
            render();
        }

        function decrementDigit(colId) {
            const currentVal = state.digits[colId] ? parseInt(state.digits[colId]) : null;
            if (currentVal === null) {
                state.digits[colId] = '9';
            } else if (currentVal === 0) {
                delete state.digits[colId];
            } else {
                state.digits[colId] = (currentVal - 1).toString();
            }
            render();
        }

        function clearAll() {
            state.digits = {};
            render();
        }

        function setSliderUnit(id) {
            state.sliderUnit = id;
            render();
        }

        function toggleInstructions(show) {
            state.showInstructions = show;
            render();
        }

        function handleWheel(e, colId) {
            e.preventDefault();
            if (e.deltaY < 0) incrementDigit(colId);
            else if (e.deltaY > 0) decrementDigit(colId);
        }

        // --- CALCULATIONS ---
        function getCellDisplay(colId) {
            const realDigit = state.digits[colId];
            if (realDigit !== undefined) return { value: realDigit, type: 'real' };

            const sliderIndex = COLUMNS.findIndex(c => c.id === state.sliderUnit);
            const colIndex = COLUMNS.findIndex(c => c.id === colId);
            
            const occupiedIndices = COLUMNS
                .map((c, i) => state.digits[c.id] !== undefined ? i : -1)
                .filter(i => i !== -1);
            
            if (occupiedIndices.length === 0) return { value: '', type: 'empty' };

            const minOccupied = Math.min(...occupiedIndices);
            const maxOccupied = Math.max(...occupiedIndices);

            if (colIndex > minOccupied && colIndex < maxOccupied) return { value: '0', type: 'ghost' };
            if (colIndex > maxOccupied && colIndex <= sliderIndex) return { value: '0', type: 'ghost' };
            if (colIndex < minOccupied && colIndex >= sliderIndex) return { value: '0', type: 'ghost' };

            return { value: '', type: 'empty' };
        }

        function calculateOutput() {
            let total = 0;
            Object.entries(state.digits).forEach(([colId, digitStr]) => {
                const col = COLUMNS.find(c => c.id === colId);
                if (col && digitStr) total += parseInt(digitStr) * col.factor;
            });
            
            if (total === 0 && Object.keys(state.digits).length === 0) return "0";

            const sliderCol = COLUMNS.find(c => c.id === state.sliderUnit);
            const result = total / sliderCol.factor;
            
            return result.toLocaleString('de-DE', { maximumFractionDigits: 6 });
        }

        // --- DRAG AND DROP LOGIC (Mobile Optimized) ---
        function handleDragStart(e) {
            // Prevent default behavior (scroll etc.)
            // e.preventDefault() here might block input focus on some devices if not careful,
            // but for the slider handle it is necessary.
            if (e.cancelable && e.target.closest('.slider-handle')) {
                 e.preventDefault();
            }
           
            state.isDragging = true;
            document.body.classList.add('cursor-ew-resize');
        }

        function handleDragMove(e) {
            if (!state.isDragging) return;

            // Prevent scrolling on mobile while dragging the slider
            if(e.cancelable) e.preventDefault();

            const clientX = e.clientX || (e.touches && e.touches[0].clientX);
            
            let closestColId = null;
            let minDist = Infinity;

            COLUMNS.forEach(col => {
                const el = document.getElementById(`col-header-${col.id}`);
                if (!el) return;
                
                const rect = el.getBoundingClientRect();
                
                if (clientX >= rect.left && clientX <= rect.right) {
                    closestColId = col.id;
                    minDist = 0;
                } else {
                    const center = rect.left + rect.width / 2;
                    const dist = Math.abs(clientX - center);
                    if (dist < minDist) {
                        minDist = dist;
                        closestColId = col.id;
                    }
                }
            });

            if (closestColId && closestColId !== state.sliderUnit) {
                setSliderUnit(closestColId); 
            }
        }

        function handleDragEnd() {
            state.isDragging = false;
            document.body.classList.remove('cursor-ew-resize');
        }

        // Global Listeners
        window.addEventListener('mousemove', handleDragMove);
        window.addEventListener('mouseup', handleDragEnd);
        // Passive: false is crucial for preventing scroll on mobile during drag
        window.addEventListener('touchmove', handleDragMove, {passive: false});
        window.addEventListener('touchend', handleDragEnd);


        // --- RENDER ENGINE ---
        function render() {
            const app = document.getElementById('app');
            
            // 1. Header (More compact on mobile)
            const headerHTML = `
                <div class="w-full max-w-5xl flex flex-col md:flex-row justify-between items-center md:items-end mb-4 pb-4 border-b border-stone-200 gap-3">
                    <div class="text-center md:text-left">
                        <h1 class="text-2xl md:text-3xl font-bold text-slate-700 flex items-center justify-center md:justify-start gap-3">
                            <i data-lucide="arrow-left-right" class="text-indigo-600 w-6 h-6 md:w-8 md:h-8"></i>
                            Umrechner Längeneinheiten
                        </h1>
                        <p class="text-stone-500 text-sm mt-1 hidden md:block">Stelle mit dem Mausrad oder durch Eingeben die Länge ein. Verschiebe dann das Komma oder klicke auf die gewünschte Einheit.</p>
                    </div>
                    <div class="flex gap-2 w-full md:w-auto justify-center">
                        <button onclick="toggleInstructions(true)" class="flex-1 md:flex-none justify-center flex items-center gap-2 px-3 py-2 text-indigo-600 bg-indigo-50 hover:bg-indigo-100 rounded-lg transition-colors font-medium text-xs md:text-sm">
                            <i data-lucide="book-open" class="w-4 h-4"></i> <span class="md:inline">Anleitung</span>
                        </button>
                        <button onclick="clearAll()" class="flex-1 md:flex-none justify-center flex items-center gap-2 px-3 py-2 text-red-600 bg-red-50 hover:bg-red-100 rounded-lg transition-colors font-medium text-xs md:text-sm">
                            <i data-lucide="trash-2" class="w-4 h-4"></i> <span class="md:inline">Löschen</span>
                        </button>
                    </div>
                </div>
            `;

            // 2. The Board
            let columnsHeaderHTML = '';
            let gridCellsHTML = '';
            let bottomStripHTML = '';

            COLUMNS.forEach(col => {
                const isActive = state.sliderUnit === col.id;
                
                // Header Column
                columnsHeaderHTML += `
                    <button 
                        id="col-header-${col.id}"
                        onclick="setSliderUnit('${col.id}')"
                        class="relative h-20 md:h-24 rounded-xl border-b-4 transition-all duration-200 flex flex-col items-center justify-center group ${col.color} ${col.border} ${isActive ? 'translate-y-1 shadow-inner border-t-4 border-t-black/5 ring-2 ring-red-500 ring-offset-2 z-10' : 'hover:-translate-y-1 shadow-md hover:shadow-lg'}"
                    >
                        <span class="text-2xl md:text-3xl font-bold text-slate-700 block mb-1">${col.label}</span>
                        <span class="text-[9px] md:text-[10px] uppercase tracking-wider text-slate-500 font-semibold opacity-70 group-hover:opacity-100">${col.sub}</span>
                        ${isActive ? '<div class="absolute -bottom-4 text-red-600 animate-bounce"><i data-lucide="chevron-down" class="w-6 h-6 fill-current"></i></div>' : ''}
                    </button>
                `;

                // Slider Overlay Logic (Enhanced touch target)
                let sliderOverlay = '';
                if (isActive) {
                    sliderOverlay = `
                        <div 
                            class="slider-handle absolute right-0 top-0 bottom-0 w-12 -translate-x-1/2 md:translate-x-1/2 z-30 cursor-ew-resize flex justify-center items-center touch-none group"
                            onmousedown="handleDragStart(event)"
                            ontouchstart="handleDragStart(event)"
                            title="Komma verschieben"
                            style="transform: translateX(50%);"
                        >
                            <!-- Visual Line -->
                            <div class="w-1.5 h-full bg-red-500 shadow-[0_0_15px_rgba(239,68,68,0.6)] relative transition-transform group-hover:scale-x-125 pointer-events-none">
                                <div class="absolute -right-3 top-2 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm select-none">KOMMA</div>
                                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-red-600 text-white p-2 rounded-full shadow-md opacity-80 md:opacity-0 group-hover:opacity-100 transition-opacity">
                                    <i data-lucide="arrow-left-right" class="w-4 h-4"></i>
                                </div>
                            </div>
                        </div>
                    `;
                }

                const display = getCellDisplay(col.id);

                gridCellsHTML += `
                    <div 
                        onwheel="handleWheel(event, '${col.id}')"
                        class="relative flex flex-col items-center bg-white rounded-xl shadow-sm border border-stone-100 hover:shadow-md transition-shadow"
                    >
                        ${sliderOverlay}
                        
                        <button onclick="incrementDigit('${col.id}')" tabindex="-1" class="w-full h-10 md:h-12 flex items-center justify-center text-stone-300 hover:text-indigo-600 hover:bg-indigo-50 active:bg-indigo-100 transition-colors rounded-t-xl active:scale-95 touch-manipulation">
                            <i data-lucide="chevron-up" class="w-6 h-6 md:w-8 md:h-8 stroke-[3]"></i>
                        </button>

                        <div class="relative w-full h-20 md:h-24 flex items-center justify-center bg-stone-50 border-y border-stone-100">
                            <input
                                id="input-${col.id}"
                                type="text" 
                                inputmode="numeric"
                                pattern="[0-9]*"
                                value="${display.type === 'real' ? display.value : ''}"
                                placeholder="${display.type === 'ghost' ? display.value : ''}"
                                oninput="updateDigit('${col.id}', this.value)"
                                onfocus="this.select()"
                                class="w-full h-full text-center text-5xl md:text-6xl font-mono font-bold bg-transparent outline-none ${display.type === 'real' ? 'text-slate-800' : 'placeholder:text-red-300 placeholder:opacity-100'}"
                            />
                            ${display.type === 'ghost' ? '<div class="absolute top-1 left-2 text-[8px] md:text-[9px] font-bold text-red-300 uppercase tracking-widest pointer-events-none">Auto</div>' : ''}
                        </div>

                        <button onclick="decrementDigit('${col.id}')" tabindex="-1" class="w-full h-10 md:h-12 flex items-center justify-center text-stone-300 hover:text-indigo-600 hover:bg-indigo-50 active:bg-indigo-100 transition-colors rounded-b-xl active:scale-95 touch-manipulation">
                            <i data-lucide="chevron-down" class="w-6 h-6 md:w-8 md:h-8 stroke-[3]"></i>
                        </button>
                    </div>
                `;

                bottomStripHTML += `
                    <div 
                        onclick="setSliderUnit('${col.id}')"
                        class="cursor-pointer flex flex-col items-center gap-1 transition-colors ${isActive ? 'text-red-500 font-bold' : 'hover:text-stone-600'}"
                    >
                        <div class="w-3 h-3 rounded-full ${isActive ? 'bg-red-500 ring-4 ring-red-100' : 'bg-stone-300'}"></div>
                        <span>${col.label}</span>
                    </div>
                `;
            });

            // 3. Modal (Mobile Responsive)
            let modalHTML = '';
            if (state.showInstructions) {
                modalHTML = `
                    <div 
                        class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in"
                        onclick="toggleInstructions(false)"
                    >
                        <div 
                            class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-5 md:p-6 animate-zoom-in relative"
                            onclick="event.stopPropagation()"
                        >
                            <div class="flex justify-between items-start mb-4 md:mb-6">
                                <h2 class="text-xl md:text-2xl font-bold text-slate-800 flex items-center gap-3">
                                    <div class="bg-indigo-100 p-2 rounded-lg text-indigo-600"><i data-lucide="book-open"></i></div>
                                    Anleitung
                                </h2>
                                <button onclick="toggleInstructions(false)" class="text-stone-400 hover:text-stone-600 hover:bg-stone-100 p-2 rounded-full transition-colors">
                                    <i data-lucide="x"></i>
                                </button>
                            </div>
                            <div class="bg-stone-50 rounded-xl p-4 md:p-5 border border-stone-200 overflow-y-auto max-h-[60vh]">
                                <ol class="list-decimal list-outside ml-4 space-y-3 md:space-y-4 text-sm md:text-base text-stone-700 leading-relaxed">
                                    <li>Stelle die gegebene Länge ein. Die kleinste Stelle vor dem Komma kommt in das Feld über der die Einheit steht.</li>
                                    <li>Es werden automatisch <strong class="text-red-500">zwingend nötige Nullen</strong> ergänzt.</li>
                                    <li>Klicke auf die gesuchte Größe oder <strong class="text-indigo-600">ziehe den roten Komma-Strich</strong> mit dem Finger an die gewünschte Stelle.</li>
                                    <li>Lies das Ergebnis unten ab.</li>
                                </ol>
                            </div>
                            <div class="mt-4 md:mt-6 flex justify-end">
                                <button onclick="toggleInstructions(false)" class="w-full md:w-auto px-6 py-2.5 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-200">
                                    Alles klar!
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            app.innerHTML = `
                ${headerHTML}
                
                <!-- Main Board Scroll Container -->
                <div class="w-full max-w-6xl flex-1 flex flex-col justify-center">
                    <div class="w-full overflow-x-auto pb-6 px-1 no-scrollbar -mx-2 md:mx-0">
                        <div class="min-w-[700px] md:min-w-[850px] relative px-2">
                            <div class="grid grid-cols-7 gap-1 md:gap-2 mb-2">
                                ${columnsHeaderHTML}
                            </div>
                            <div class="grid grid-cols-7 gap-1 md:gap-2 bg-stone-200 p-1 md:p-2 rounded-2xl shadow-inner border border-stone-300">
                                ${gridCellsHTML}
                            </div>
                            <div class="mt-4 px-4 py-2">
                                <div class="flex justify-between items-center text-xs md:text-sm font-medium text-stone-400">
                                    ${bottomStripHTML}
                                </div>
                                <div class="relative h-0.5 bg-stone-200 -mt-[1.3rem] -z-10 mx-2"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                ${modalHTML}
            `;

            document.getElementById('res-value').textContent = calculateOutput();
            document.getElementById('res-unit').textContent = state.sliderUnit;

            lucide.createIcons();

            if (state.lastFocusedInput) {
                const el = document.getElementById(state.lastFocusedInput.id);
                if (el) el.focus();
            }
        }

        render();

    </script>
</body>
</html>

