<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interaktive Stellenwerttafel</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Custom Animations & Utilities not included in standard Tailwind CDN */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes zoomIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        .animate-slide-up { animation: slideUp 0.5s ease-out; }
        .animate-zoom-in { animation: zoomIn 0.2s ease-out; }

        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* Input styling to remove spinner buttons */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
    </style>
</head>
<body class="bg-stone-50 font-sans text-slate-800 min-h-screen select-none">

    <div id="app" class="flex flex-col items-center p-2 md:p-6 min-h-screen relative">
        <!-- Content will be injected here by JavaScript -->
    </div>

    <script>
        // --- KONFIGURATION ---
        const COLUMNS = [
            { id: 'km', label: 'km', sub: 'Kilometer', factor: 1000000, color: 'bg-red-100', border: 'border-red-200' },
            { id: 'hm', label: 'hm', sub: 'Hektometer', factor: 100000, color: 'bg-orange-100', border: 'border-orange-200' },
            { id: 'dam', label: 'dam', sub: 'Dekameter', factor: 10000, color: 'bg-orange-50', border: 'border-orange-100' },
            { id: 'm', label: 'm', sub: 'Meter', factor: 1000, color: 'bg-yellow-100', border: 'border-yellow-200' },
            { id: 'dm', label: 'dm', sub: 'Dezimeter', factor: 100, color: 'bg-green-100', border: 'border-green-200' },
            { id: 'cm', label: 'cm', sub: 'Zentimeter', factor: 10, color: 'bg-teal-100', border: 'border-teal-200' },
            { id: 'mm', label: 'mm', sub: 'Millimeter', factor: 1, color: 'bg-blue-100', border: 'border-blue-200' },
        ];

        // --- STATE MANAGEMENT ---
        const state = {
            digits: {}, // { 'm': '5', 'cm': '2' }
            sliderUnit: 'm',
            showInstructions: false,
            isDragging: false,
            lastFocusedInput: null // Helper to restore focus after render
        };

        // --- LOGIC FUNCTIONS ---

        function updateDigit(colId, value) {
            // Save focus info
            state.lastFocusedInput = { id: `input-${colId}`, cursor: null };

            if (value === '' || value === null) {
                delete state.digits[colId];
            } else {
                const cleanVal = value.toString().slice(-1); // Take last char
                if (/[0-9]/.test(cleanVal)) {
                    state.digits[colId] = cleanVal;
                }
            }
            render();
        }

        function incrementDigit(colId) {
            const currentVal = state.digits[colId] ? parseInt(state.digits[colId]) : null;
            let nextVal = currentVal === null ? 1 : (currentVal === 9 ? 0 : currentVal + 1);
            state.digits[colId] = nextVal.toString();
            render();
        }

        function decrementDigit(colId) {
            const currentVal = state.digits[colId] ? parseInt(state.digits[colId]) : null;
            if (currentVal === null) {
                state.digits[colId] = '9';
            } else if (currentVal === 0) {
                delete state.digits[colId];
            } else {
                state.digits[colId] = (currentVal - 1).toString();
            }
            render();
        }

        function clearAll() {
            state.digits = {};
            render();
        }

        function setSliderUnit(id) {
            state.sliderUnit = id;
            render();
        }

        function toggleInstructions(show) {
            state.showInstructions = show;
            render();
        }

        function handleWheel(e, colId) {
            e.preventDefault();
            if (e.deltaY < 0) incrementDigit(colId);
            else if (e.deltaY > 0) decrementDigit(colId);
        }

        // --- CALCULATIONS ---

        function getCellDisplay(colId) {
            const realDigit = state.digits[colId];
            if (realDigit !== undefined) return { value: realDigit, type: 'real' };

            const sliderIndex = COLUMNS.findIndex(c => c.id === state.sliderUnit);
            const colIndex = COLUMNS.findIndex(c => c.id === colId);
            
            // Find range of occupied cells
            const occupiedIndices = COLUMNS
                .map((c, i) => state.digits[c.id] !== undefined ? i : -1)
                .filter(i => i !== -1);
            
            if (occupiedIndices.length === 0) return { value: '', type: 'empty' };

            const minOccupied = Math.min(...occupiedIndices);
            const maxOccupied = Math.max(...occupiedIndices);

            // Logic for "Ghost Zeros"
            if (colIndex > minOccupied && colIndex < maxOccupied) return { value: '0', type: 'ghost' };
            if (colIndex > maxOccupied && colIndex <= sliderIndex) return { value: '0', type: 'ghost' };
            if (colIndex < minOccupied && colIndex >= sliderIndex) return { value: '0', type: 'ghost' };

            return { value: '', type: 'empty' };
        }

        function calculateOutput() {
            let total = 0;
            Object.entries(state.digits).forEach(([colId, digitStr]) => {
                const col = COLUMNS.find(c => c.id === colId);
                if (col && digitStr) total += parseInt(digitStr) * col.factor;
            });
            
            if (total === 0 && Object.keys(state.digits).length === 0) return "0";

            const sliderCol = COLUMNS.find(c => c.id === state.sliderUnit);
            const result = total / sliderCol.factor;
            
            return result.toLocaleString('de-DE', { maximumFractionDigits: 6 });
        }

        // --- DRAG AND DROP LOGIC ---

        function handleDragStart(e) {
            state.isDragging = true;
            document.body.classList.add('cursor-ew-resize');
            e.preventDefault();
        }

        function handleDragMove(e) {
            if (!state.isDragging) return;

            const clientX = e.clientX || (e.touches && e.touches[0].clientX);
            
            // Find closest column
            let closestColId = null;
            let minDist = Infinity;

            COLUMNS.forEach(col => {
                const el = document.getElementById(`col-header-${col.id}`);
                if (!el) return;
                
                const rect = el.getBoundingClientRect();
                
                // Is mouse within this column's horizontal bounds?
                if (clientX >= rect.left && clientX <= rect.right) {
                    closestColId = col.id;
                    minDist = 0;
                } else {
                    const center = rect.left + rect.width / 2;
                    const dist = Math.abs(clientX - center);
                    if (dist < minDist) {
                        minDist = dist;
                        closestColId = col.id;
                    }
                }
            });

            if (closestColId && closestColId !== state.sliderUnit) {
                setSliderUnit(closestColId); // This triggers render
            }
        }

        function handleDragEnd() {
            state.isDragging = false;
            document.body.classList.remove('cursor-ew-resize');
        }

        // Global Event Listeners for Drag
        window.addEventListener('mousemove', handleDragMove);
        window.addEventListener('mouseup', handleDragEnd);
        window.addEventListener('touchmove', handleDragMove, {passive: false});
        window.addEventListener('touchend', handleDragEnd);

        // --- RENDER ENGINE ---

        function render() {
            const app = document.getElementById('app');
            
            // Build HTML Strings
            
            // 1. Header
            const headerHTML = `
                <div class="w-full max-w-5xl flex flex-col md:flex-row justify-between items-end mb-6 pb-4 border-b border-stone-200 gap-4">
                    <div>
                        <h1 class="text-3xl font-bold text-slate-700 flex items-center gap-3">
                            <i data-lucide="arrow-left-right" class="text-indigo-600 w-8 h-8"></i>
                            Stellenwerttafel
                        </h1>
                        <p class="text-stone-500 mt-1 ml-1">Verschiebe das rote Komma oder nutze die Pfeiltasten.</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="toggleInstructions(true)" class="flex items-center gap-2 px-4 py-2 text-indigo-600 bg-indigo-50 hover:bg-indigo-100 rounded-lg transition-colors font-medium text-sm">
                            <i data-lucide="book-open" class="w-4 h-4"></i> Anleitung
                        </button>
                        <button onclick="clearAll()" class="flex items-center gap-2 px-4 py-2 text-red-600 bg-red-50 hover:bg-red-100 rounded-lg transition-colors font-medium text-sm">
                            <i data-lucide="trash-2" class="w-4 h-4"></i> Alles löschen
                        </button>
                    </div>
                </div>
            `;

            // 2. The Board
            let columnsHeaderHTML = '';
            let gridCellsHTML = '';
            let bottomStripHTML = '';

            COLUMNS.forEach(col => {
                const isActive = state.sliderUnit === col.id;
                
                // Header Column
                columnsHeaderHTML += `
                    <button 
                        id="col-header-${col.id}"
                        onclick="setSliderUnit('${col.id}')"
                        class="relative h-24 rounded-xl border-b-4 transition-all duration-200 flex flex-col items-center justify-center group ${col.color} ${col.border} ${isActive ? 'translate-y-1 shadow-inner border-t-4 border-t-black/5 ring-2 ring-red-500 ring-offset-2 z-10' : 'hover:-translate-y-1 shadow-md hover:shadow-lg'}"
                    >
                        <span class="text-3xl font-bold text-slate-700 block mb-1">${col.label}</span>
                        <span class="text-[10px] uppercase tracking-wider text-slate-500 font-semibold opacity-70 group-hover:opacity-100">${col.sub}</span>
                        ${isActive ? '<div class="absolute -bottom-4 text-red-600 animate-bounce"><i data-lucide="chevron-down" class="w-6 h-6 fill-current"></i></div>' : ''}
                    </button>
                `;

                // Grid Cell
                const display = getCellDisplay(col.id);
                
                // Slider Overlay Logic
                let sliderOverlay = '';
                if (isActive) {
                    sliderOverlay = `
                        <div 
                            onmousedown="handleDragStart(event)"
                            ontouchstart="handleDragStart(event)"
                            class="absolute right-0 top-0 bottom-0 w-8 translate-x-1/2 z-30 cursor-ew-resize flex justify-center items-center touch-none group"
                            title="Komma verschieben"
                        >
                            <div class="w-1.5 h-full bg-red-500 shadow-[0_0_15px_rgba(239,68,68,0.6)] relative transition-transform group-hover:scale-x-125">
                                <div class="absolute -right-3 top-2 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm select-none pointer-events-none">KOMMA</div>
                                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-red-600 text-white p-1 rounded-full shadow-md opacity-0 group-hover:opacity-100 transition-opacity">
                                    <i data-lucide="arrow-left-right" class="w-3 h-3"></i>
                                </div>
                            </div>
                        </div>
                    `;
                }

                gridCellsHTML += `
                    <div 
                        onwheel="handleWheel(event, '${col.id}')"
                        class="relative flex flex-col items-center bg-white rounded-xl shadow-sm border border-stone-100 cursor-ns-resize hover:shadow-md transition-shadow"
                    >
                        ${sliderOverlay}
                        
                        <button onclick="incrementDigit('${col.id}')" tabindex="-1" class="w-full h-10 flex items-center justify-center text-stone-300 hover:text-indigo-600 hover:bg-indigo-50 active:bg-indigo-100 transition-colors rounded-t-xl">
                            <i data-lucide="chevron-up" class="w-6 h-6 stroke-[3]"></i>
                        </button>

                        <div class="relative w-full h-24 flex items-center justify-center bg-stone-50 border-y border-stone-100">
                            <input
                                id="input-${col.id}"
                                type="text" 
                                inputmode="numeric"
                                value="${display.type === 'real' ? display.value : ''}"
                                placeholder="${display.type === 'ghost' ? display.value : ''}"
                                oninput="updateDigit('${col.id}', this.value)"
                                onfocus="this.select()"
                                class="w-full h-full text-center text-6xl font-mono font-bold bg-transparent outline-none ${display.type === 'real' ? 'text-slate-800' : 'placeholder:text-red-300 placeholder:opacity-100'}"
                            />
                            ${display.type === 'ghost' ? '<div class="absolute top-1 left-2 text-[9px] font-bold text-red-300 uppercase tracking-widest pointer-events-none">Auto</div>' : ''}
                        </div>

                        <button onclick="decrementDigit('${col.id}')" tabindex="-1" class="w-full h-10 flex items-center justify-center text-stone-300 hover:text-indigo-600 hover:bg-indigo-50 active:bg-indigo-100 transition-colors rounded-b-xl">
                            <i data-lucide="chevron-down" class="w-6 h-6 stroke-[3]"></i>
                        </button>
                    </div>
                `;

                // Bottom Strip
                bottomStripHTML += `
                    <div 
                        onclick="setSliderUnit('${col.id}')"
                        class="cursor-pointer flex flex-col items-center gap-1 transition-colors ${isActive ? 'text-red-500 font-bold' : 'hover:text-stone-600'}"
                    >
                        <div class="w-3 h-3 rounded-full ${isActive ? 'bg-red-500 ring-4 ring-red-100' : 'bg-stone-300'}"></div>
                        <span>${col.label}</span>
                    </div>
                `;
            });

            // 3. Result Card
            const resultCardHTML = `
                <div class="fixed bottom-6 z-40 animate-slide-up">
                    <div class="bg-stone-800/95 backdrop-blur-md text-white p-6 rounded-2xl shadow-2xl border border-stone-600 flex items-center gap-6 min-w-[300px]">
                        <div>
                            <div class="text-stone-400 text-xs font-bold uppercase tracking-wider mb-1">Ergebnis</div>
                            <div class="text-5xl font-mono font-bold text-green-400 tabular-nums tracking-tight">
                                ${calculateOutput()}
                            </div>
                        </div>
                        <div class="h-12 w-px bg-stone-600"></div>
                        <div class="text-3xl font-bold text-white">
                            ${state.sliderUnit}
                        </div>
                    </div>
                </div>
            `;

            // 4. Modal
            let modalHTML = '';
            if (state.showInstructions) {
                modalHTML = `
                    <div 
                        class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in"
                        onclick="toggleInstructions(false)"
                    >
                        <div 
                            class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6 animate-zoom-in relative"
                            onclick="event.stopPropagation()"
                        >
                            <div class="flex justify-between items-start mb-6">
                                <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-3">
                                    <div class="bg-indigo-100 p-2 rounded-lg text-indigo-600"><i data-lucide="book-open"></i></div>
                                    Anleitung
                                </h2>
                                <button onclick="toggleInstructions(false)" class="text-stone-400 hover:text-stone-600 hover:bg-stone-100 p-2 rounded-full transition-colors">
                                    <i data-lucide="x"></i>
                                </button>
                            </div>
                            <div class="bg-stone-50 rounded-xl p-5 border border-stone-200">
                                <ol class="list-decimal list-outside ml-4 space-y-4 text-stone-700 leading-relaxed">
                                    <li>Stelle die gegebene Länge ein (z.B. <span class="font-mono bg-white px-1 border border-stone-200 rounded">54,81 m</span>). Die kleinste Stelle vor dem Komma kommt in das Feld über der die Einheit steht (hier also: <strong class="text-indigo-600">4</strong> in das Feld mit <strong class="text-indigo-600">Meter</strong>).</li>
                                    <li>Es werden automatisch <strong class="text-red-500">zwingend nötige Nullen</strong> ergänzt.</li>
                                    <li>Klicke auf die gesuchte Größe oder <strong class="text-indigo-600">ziehe den roten Komma-Strich</strong> mit der Maus an die gewünschte Stelle.</li>
                                    <li>Du kannst nun die Länge ablesen.</li>
                                </ol>
                            </div>
                            <div class="mt-6 flex justify-end">
                                <button onclick="toggleInstructions(false)" class="px-6 py-2.5 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-200">
                                    Alles klar!
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Assembly
            app.innerHTML = `
                ${headerHTML}
                <div class="w-full max-w-6xl overflow-x-auto pb-12 px-2 no-scrollbar">
                    <div class="min-w-[850px] relative">
                        <div class="grid grid-cols-7 gap-2 mb-2">
                            ${columnsHeaderHTML}
                        </div>
                        <div class="grid grid-cols-7 gap-2 bg-stone-200 p-2 rounded-2xl shadow-inner border border-stone-300">
                            ${gridCellsHTML}
                        </div>
                        <div class="mt-4 px-4 py-2">
                            <div class="flex justify-between items-center text-sm font-medium text-stone-400">
                                ${bottomStripHTML}
                            </div>
                            <div class="relative h-0.5 bg-stone-200 -mt-[1.3rem] -z-10 mx-2"></div>
                        </div>
                    </div>
                </div>
                ${resultCardHTML}
                ${modalHTML}
            `;

            // Re-Initialize Icons
            lucide.createIcons();

            // Restore Focus if needed
            if (state.lastFocusedInput) {
                const el = document.getElementById(state.lastFocusedInput.id);
                if (el) {
                    el.focus();
                    // Optional: Restore cursor position logic if needed, but for 1 digit inputs it's fine.
                }
            }
        }

        // Initial Render
        render();

    </script>
</body>
</html>
